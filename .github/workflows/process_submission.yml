name: Process Paper Submission

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - main

jobs:
  process-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    if: >
      (vars.AUTO_PROCESS_SUBMISSIONS == 'true' || 
       contains(github.event.pull_request.labels.*.name, 'Action: Process')) 

    steps:
      # 1. 获取 PR 数据 (放到 pr_workspace)
      - name: Checkout PR Data
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          path: pr_workspace

      # 2. 获取 Main 逻辑和基准数据 (放到 main_workspace)
      - name: Checkout Main Logic & Base Data
        uses: actions/checkout@v4
        with:
          ref: main
          repository: ${{ github.repository }}
          fetch-depth: 0
          path: main_workspace

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.13

      - name: Install Dependencies
        working-directory: main_workspace
        run: uv sync --frozen

      # 3. 构造混合环境 (Hybrid Environment)
      # 这是一个极其关键的步骤：
      # - 脚本、Core Excel、README 来自 Main (安全、基准)
      # - Figures 来自 Main (原有)
      # - Templates 来自 PR (新增)
      # - Figures 来自 PR (新增，放到 pr_workspace/figures 供脚本读取)
      # - Backups 来自 PR (如果需要合并)
      - name: Setup Hybrid Environment
        run: |
          # A. 将 Main 的内容复制到当前工作目录 (覆盖)
          cp -r main_workspace/* .
          cp -r main_workspace/.git .
          
          # B. 引入 PR 的 Templates (覆盖 Main 的空模板)
          if [ -f pr_workspace/submit_template.xlsx ]; then
            cp pr_workspace/submit_template.xlsx .
          fi
          if [ -f pr_workspace/submit_template.json ]; then
            cp pr_workspace/submit_template.json .
          fi
          
          # C. 处理 Backups (不覆盖，仅合并)
          if [ -d pr_workspace/backups ]; then
            mkdir -p backups
            cp -rn pr_workspace/backups/* backups/ || true
          fi
          
          # D. Figures 处理
          # 我们不直接合并 PR 的 figures 到 figures/，而是让脚本去读 pr_workspace/figures
          # 这样可以防止同名文件的错误覆盖
          
          echo "Environment prepared."

      # 4. 验证 (使用 Main 的脚本验证 PR 的 Template)
      - name: Validate Submission
        id: validate
        env:
          PYTHONPATH: .
        shell: bash
        run: |
          # 模拟 changed_files，这里简化为验证模板是否存在
          set -o pipefail
          uv run python scripts/validate_submission.py 2>&1 | tee validation_log.txt

      - name: Comment on Validation Failure
        if: failure() && steps.validate.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let logContent = '';
            try { logContent = fs.readFileSync('validation_log.txt', 'utf8'); } catch(e) { logContent = 'Log missing'; }
            const author = context.payload.pull_request.user.login;
            const body = `### ❌ Validation Failed\nHi @${author}, logic verification failed:\n<details><summary>Log</summary>\n\n\`\`\`text\n${logContent}\n\`\`\`\n</details>`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # 5. 处理图片 (指定 PR 图片源)
      - name: Update Figures
        if: success()
        env:
          PYTHONPATH: .
          # 关键：告诉脚本去哪里找新图片
          PR_FIGURES_DIR: pr_workspace/figures
        run: uv run python scripts/update_submission_figures.py

      # 6. 核心更新 (Update.py)
      - name: Run Core Update
        id: core_update
        if: success()
        env:
          PYTHONPATH: .
          DEEPSEEK_API: ${{ secrets.DEEPSEEK_API }}
          EXCEL_KEY: ${{ secrets.EXCEL_KEY }}
        run: |
          set -o pipefail
          uv run python src/update.py 2>&1 | tee update_log.txt

      # 7. 评论日志
      - name: Comment Update Log
        if: steps.core_update.conclusion != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let logContent = '';
            try { logContent = fs.readFileSync('update_log.txt', 'utf8'); } catch(e) { logContent = 'Log missing.'; }
            const author = context.payload.pull_request.user.login;
            const statusIcon = '${{ steps.core_update.outcome }}' === 'success' ? '✅' : '⚠️';
            const body = `### ${statusIcon} Core Update Log\nHi @${author}, update executed.\n<details><summary>Full Log</summary>\n\n\`\`\`text\n${logContent}\n\`\`\`\n</details>`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # 8. 结果提交并推送 (主分支和pr分支双向同步)
      - name: Commit and Push
        if: success()
        env:
          PYTHONPATH: .
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 获取 Core Excel 路径
          CORE_EXCEL_PATH=$(uv run python -c "from src.core.config_loader import get_config_instance; print(get_config_instance().settings['paths']['core_excel'])")
          
          # 添加变动文件
          # 使用 -f 强制添加，确保即便是被 ignore 的文件也能进去
          git add -f "$CORE_EXCEL_PATH" README.md figures/ backups/
          
          # 注意：此时 submit_template.xlsx 已经被 update.py 处理过（移除了已添加的论文）
          # 我们不希望把这个“清空”的操作提交到 Main (Main 应该保持干净的空模板或特定状态)
          # 但通常为了反馈给用户“你的论文已处理”，在 PR 分支里提交清空后的模板是合理的。
          # 这里策略：Main 分支保留模板（重置），PR 分支提交清空后的模板。
          # 但为了简化，我们先提交核心数据。
          
          # 提交到本地 (HEAD 目前指向 main 的某个 commit)
          PR_USER="${{ github.event.pull_request.user.login }}"
          git commit -m "Auto-process: Update database & figures by @$PR_USER [skip ci]" || echo "No changes to commit"
          
          # --- 动作 A: 推送到 Main 分支 ---
          # 还原 template 到 main 原始状态 (保持 main 的模板干净)
          git checkout HEAD -- submit_template.xlsx submit_template.json || true
          # 推送
          git push origin HEAD:main
          echo "✅ Pushed to main"
          
          # --- 动作 B: 推送到 PR 分支 ---
          # 我们希望 PR 分支包含处理后的结果（包括 update_submission_figures 改名后的 Excel，以及移除已处理论文后的 Excel）
          # 这需要一点技巧，因为我们现在的 HEAD 是 Main 上的。
          
          # 1. 切回 PR 分支的引用 (不 checkout 文件，只切指针)
          # git fetch origin ${{ github.event.pull_request.head.ref }}
          # 这一步比较复杂，因为文件可能会冲突。
          
          # 简化策略：直接把刚才生成的文件 Force Push 到 PR 分支？
          # 不行，那样会覆盖用户 PR 的历史。
          
          # 正确策略：
          # 1. 刚才我们 commit 到了本地 HEAD (基于 Main)。
          # 2. 我们把它推到了 Main。
          # 3. 现在，我们要把这个状态同步给 PR 分支。
          # 如果 PR 分支是基于 Main 的，直接 merge 即可。
          
          git fetch origin ${{ github.event.pull_request.head.ref }}
          
          # 尝试将刚才的 commit cherry-pick 到 PR 分支？或者直接 merge？
          # 鉴于我们是在 Main 环境下运行的，直接 Force Push Main 的内容到 PR 分支
          # 会导致 PR 变成 Main 的样子（丢失 PR 独有的无关文件）。
          
          # 因此只把 Main 更新后的核心文件推送回 PR 分支。
          # 1. 切换到 PR 分支
          git checkout -f ${{ github.event.pull_request.head.ref }}
          # 2. 从刚才的 Main commit (HEAD@{1}) 检出核心文件
          git checkout HEAD@{1} -- "$CORE_EXCEL_PATH" README.md figures/ backups/
          # 3. 提交
          git add "$CORE_EXCEL_PATH" README.md figures/ backups/
          git commit -m "Sync with processed result [skip ci]" || echo "No changes"
          # 4. 推送
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
          echo "✅ Pushed back to PR branch"

      # 9. 通知
      - name: Send Notification
        if: always()
        env:
          PYTHONPATH: .
          NOTIFICATION_EMAIL: ${{ vars.NOTIFICATION_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          workflow_status: ${{ job.status }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_USER: ${{ github.event.pull_request.user.login }}
        run: uv run python scripts/send_notification.py