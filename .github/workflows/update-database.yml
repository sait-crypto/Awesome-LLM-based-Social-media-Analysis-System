name: Process Paper Submission PR

on:
  pull_request:
    paths:
      - 'submit_template.json'
      - 'submit_template.xlsx'
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  process-submission:
    runs-on: ubuntu-latest
    
    # ä»…åœ¨ç‰¹å®šè·¯å¾„æ›´æ”¹æ—¶æ‰è¿è¡Œ
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'paper-submission') ||
      contains(github.event.pull_request.head.ref, 'paper-submission')
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl requests python-dateutil
        
        # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†å¿…éœ€çš„åŒ…
        python -c "import pandas, openpyxl, requests; print('Dependencies installed successfully')"
    
    - name: Check for update files
      id: check-files
      run: |
        echo "Checking for update files..."
        JSON_EXISTS=false
        EXCEL_EXISTS=false
        
        if [ -f "submit_template.json" ] && [ -s "submit_template.json" ]; then
          echo "Found non-empty submit_template.json"
          JSON_EXISTS=true
        fi
        
        if [ -f "submit_template.xlsx" ] && [ -s "submit_template.xlsx" ]; then
          echo "Found non-empty submit_template.xlsx"
          EXCEL_EXISTS=true
        fi
        
        echo "json_exists=$JSON_EXISTS" >> $GITHUB_OUTPUT
        echo "excel_exists=$EXCEL_EXISTS" >> $GITHUB_OUTPUT
        
        if [ "$JSON_EXISTS" = "false" ] && [ "$EXCEL_EXISTS" = "false" ]; then
          echo "No update files found or they are empty"
          exit 1
        fi
    
    - name: Set up environment variables
      run: |
        # è®¾ç½®Excelå¯†ç ï¼ˆä»GitHub Secretè¯»å–ï¼‰
        if [ -n "${{ secrets.EXCEL_KEY }}" ]; then
          echo "EXCEL_KEY=${{ secrets.EXCEL_KEY }}" >> $GITHUB_ENV
        else
          echo "EXCEL_KEY=" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®DeepSeek APIå¯†é’¥ï¼ˆä»GitHub Secretè¯»å–ï¼‰
        if [ -n "${{ secrets.DEEPSEEK_API }}" ]; then
          echo "DEEPSEEK_API=${{ secrets.DEEPSEEK_API }}" >> $GITHUB_ENV
        else
          echo "DEEPSEEK_API=" >> $GITHUB_ENV
        fi
        
        # è®¾ç½®å…¶ä»–ç¯å¢ƒå˜é‡
        echo "GITHUB_PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
        echo "GITHUB_PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
        echo "GITHUB_PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
    
    - name: Run update processor
      id: update-process
      run: |
        echo "Running update processor..."
        
        # è¿è¡Œæ›´æ–°è„šæœ¬
        cd scripts
        python update.py
        
        # æ£€æŸ¥æ›´æ–°ç»“æœ
        if [ -f "update_result.json" ]; then
          RESULT=$(cat update_result.json)
          echo "result=$RESULT" >> $GITHUB_OUTPUT
        else
          echo "result={\"success\": false, \"message\": \"No result file generated\"}" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Generate README
      if: steps.update-process.outcome == 'success'
      run: |
        echo "Generating README..."
        cd scripts
        python convert.py
        
        # æ£€æŸ¥READMEæ˜¯å¦æ›´æ–°
        if git diff --name-only HEAD | grep -q "README.md"; then
          echo "README updated"
          echo "readme_updated=true" >> $GITHUB_ENV
        else
          echo "README not changed"
          echo "readme_updated=false" >> $GITHUB_ENV
        fi
    
    - name: Commit changes
      if: steps.update-process.outcome == 'success'
      run: |
        echo "Committing changes..."
        
        # é…ç½®Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet; then
          echo "No changes to commit"
          echo "changes_committed=false" >> $GITHUB_ENV
        else
          # æ·»åŠ æ›´æ”¹
          git add .
          
          # æäº¤æ›´æ”¹
          COMMIT_MESSAGE="Automated update from PR #$GITHUB_PR_NUMBER"
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯ï¼ˆPRåˆ†æ”¯ï¼‰
          git push
          
          echo "Changes committed and pushed"
          echo "changes_committed=true" >> $GITHUB_ENV
        fi
    
    - name: Create summary comment
      run: |
        echo "Creating PR comment..."
        
        # åˆ›å»ºå¤„ç†ç»“æœæ‘˜è¦
        SUMMARY="## ğŸ“Š Paper Submission Processing Result\n\n"
        
        if [ "${{ steps.update-process.outcome }}" = "success" ]; then
          SUMMARY+="âœ… **Successfully processed submission**\n\n"
          
          # ä»æ­¥éª¤è¾“å‡ºè·å–ç»“æœ
          RESULT='${{ steps.update-process.outputs.result }}'
          
          if [ -n "$RESULT" ] && [ "$RESULT" != "null" ]; then
            # è§£æJSONç»“æœï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
            SUMMARY+="- Update processed successfully\n"
          else
            SUMMARY+="- Update processed (no detailed result)\n"
          fi
          
          if [ "$readme_updated" = "true" ]; then
            SUMMARY+="- README updated\n"
          fi
          
          if [ "$changes_committed" = "true" ]; then
            SUMMARY+="- Changes committed to PR branch\n"
          fi
          
          SUMMARY+="\nThank you for your submission! The paper database has been updated."
          
        else
          SUMMARY+="âŒ **Processing failed**\n\n"
          SUMMARY+="The submission could not be processed automatically.\n\n"
          SUMMARY+="**Possible reasons:**\n"
          SUMMARY+="- Invalid file format\n"
          SUMMARY+="- Missing required fields\n"
          SUMMARY+="- Database update error\n\n"
          SUMMARY+="Please check your submission and try again, or contact the maintainers."
        fi
        
        # æ·»åŠ å¤„ç†ä¿¡æ¯
        SUMMARY+="\n\n---\n"
        SUMMARY+="**Process Information:**\n"
        SUMMARY+="- PR: #$GITHUB_PR_NUMBER by @$GITHUB_PR_AUTHOR\n"
        SUMMARY+="- Run ID: ${{ github.run_id }}\n"
        SUMMARY+="- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # è¾“å‡ºæ‘˜è¦ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
        echo "$SUMMARY" > pr_summary.md
        
        # ä¹Ÿå¯ä»¥åœ¨GitHub Actionsæ—¥å¿—ä¸­æ˜¾ç¤º
        echo "$SUMMARY"
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('pr_summary.md', 'utf8');
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¥è‡ªæœ¬Actionçš„è¯„è®º
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Paper Submission Processing Result')
          );
          
          if (botComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: summary
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }
    
    - name: Send notification email
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: submitter
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Paper Submission PR #${{ github.event.pull_request.number }} - ${{ job.status }}"
        to: 2182712226@qq.com
        from: GitHub Actions <submitter>
        body: |
          Paper submission PR #${{ github.event.pull_request.number }} has been processed.
          
          Status: ${{ job.status }}
          PR Title: ${{ github.event.pull_request.title }}
          Author: @${{ github.event.pull_request.user.login }}
          
          View PR: ${{ github.event.pull_request.html_url }}
          View Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          
          $(cat pr_summary.md)
    
    - name: Clean up update files
      if: steps.update-process.outcome == 'success'
      run: |
        echo "Cleaning up update files..."
        
        # æ¸…ç©ºæ›´æ–°æ–‡ä»¶
        echo '{"papers": []}' > submit_template.json
        
        # åˆ›å»ºç©ºçš„Excelæ–‡ä»¶
        python -c "
        import pandas as pd
        df = pd.DataFrame()
        df.to_excel('submit_template.xlsx', index=False)
        "
        
        # æäº¤æ¸…ç†
        if [ "$changes_committed" = "true" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add submit_template.json submit_template.xlsx
          git commit -m "Clear update files after processing"
          git push
        fi
    
    - name: Add labels
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // æ·»åŠ å¤„ç†çŠ¶æ€æ ‡ç­¾
          const labels = ['paper-submission'];
          
          if ('${{ steps.update-process.outcome }}' === 'success') {
            labels.push('processed-successfully');
          } else {
            labels.push('needs-review');
          }
          
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: labels
          });